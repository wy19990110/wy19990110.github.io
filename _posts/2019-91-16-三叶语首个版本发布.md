---
layout:     post
title:      为FGCOM配置Asterisk服务器
subtitle:   v0.6版
date:       2020-05-11
author:     王一
header-img: img/post-bg-cook.jpg
catalog: true
tags:
    - 话音系统
    - VoIP
---

---

## 关于FGCOM与Asterisk

### 项目需求

最近的仿真项目需要做一个PTT的话音系统，话音是指挥仿真中非常基础也是非常重要的一个功能。
组里调研了一下，准备使用Zellowork，或者Mumble的SDK写一个客户端和服务器端。

我看这个功能多半还是要在各个频道进行PTT的通话，不如看看现在的飞行模拟软件使用的方案，能省点开发量。
不然就凭我怕是直接掉在这坑里出不来了。

开源的雷达模拟机软件ATCpie使用的方案是调用FlightGear带的FGCOM。

### FGCOM及其工作

在FlightGear中，FGCOM是这样工作的：

转动航电GUI上面的频率旋钮选择频率，随即FGCOM就将加入这个选定的频道，类似于加入了一个会议室。

此时FlightGear将用户的麦克风静音，仅听到频道中其他人的交流。当按下指定的通话按键时，FlightGear将频道静音，同时打开麦克风，把用户语音传到服务器，让其他用户能听到。

这样一来，软件就模拟了一种**半双工**的工作方式。

* 注意一下，这里说FlightGear做了这些工作，也就是说PTT的功能是需要额外编程实现的，FGCOM实现的是加入语音会议的功能。关于如何编程实现，可以参考ATC-pie的源码。

### 命令行传参

FlightGear调用FGGOM时，通过**命令行传参**的方式将频道的频率信息，以及用户的呼号、用户名、密码，所要连接的服务器地址及端口，传给FGCOM。在命令行中输入``fgcom.exe --help``可以预览所有参数使用方式。

下面这行命令就指定了使用的服务器（本地）以及需要加入的频道（EchoTest，你将听到所有你说的话）。

    fgcom.exe --server=127.0.0.1 --frequency=910.000

### FGCOM与Asterisk

FGCOM使用IAX2协议([Inter-Asterisk eXchange，Asterisk 内部交换协议](https://baike.baidu.com/item/IAX))，这是一种主要用于在Asterisk服务器之间，对网络上的语音流进行控制的协议。它使用UDP的4569端口。

相较于在VoIP中更为广泛应用的SIP协议，IAX协议使用带内传输的方式，信令与语音信息走一个端口。这样做的好处是面对NAT时能更加灵活，便于内网穿透。

目前来说，只要知道这是和HTTP、SMTP一样的应用层协议就可以，在整个搭建服务器的过程中，**没有**需要对这个协议有深入了解的地方。

既然使用了一种Asterisk内部的协议，那不如就使用Asterisk搭建一个服务器。Asterisk标榜的就是易于配置和使用，而且FlightGear的开发者提供了必要的配置文件。只需要向Asterisk服务器写入配置并运行，就可以为FGCOM提供语音接入服务。

### 关于Asterisk

关于Asterisk，有一本中文的[小册子](https://wy19990110.github.io/files/1.pdf)提供了大体介绍。向开发者以及译者表示感谢。

简单说来，Asterisk提供了模拟的PBX功能（[Private Branch Exchange](https://baike.baidu.com/item/PBX/3737223?fr=aladdin),用户级交换机，即公司内部使用的电话业务网络），或者说是在IP网络上提供PBX功能。

事实上，Asterisk最主要的功能是搭建一个电话网络，把双方（普通的电话通话）或者是多方（电话会议）的语音按一定规则进行转发，使得用户能通过语音互相交流。这听起来像是一个路由器（[Router](https://baike.baidu.com/item/%E8%B7%AF%E7%94%B1%E5%99%A8)）的功能。

当然，Asterisk还可以通过控制一些特殊硬件，充当网关，将分组交换网络上的数据桥接([Bridging](https://baike.baidu.com/item/%E6%A1%A5%E6%8E%A5))到模拟电话网上，使得传统电话和IP电话可以互相拨打。为FGCOM配置服务器的过程中，显然无需使用这项功能。

在本篇博文中，将以不求甚解的方式介绍Asterisk的配置，仅提及必要的IAX与拨号方案的配置细节。

---

## 前期准备

这一节主要是介绍如何配置一个安装Asterisk所需的环境。

Asterisk Server环境有多种方式进行配置，[FGCOM的Wiki页面]((http://wiki.flightgear.org/Howto:Set_up_a_FGCom_server))给出了使用Linux的几个流行的发行版本进行安装的流程。Free PXB官方提供了一种集成了Asterisk所需环境的CentOS 6镜像，安装完系统就可以直接进入使用。此外，有爱好者将Asterisk移植到了Windows平台上，可能是因为使用的系统API的兼容性问题，这个移植版在Windows 10上会出现内存泄漏问题，XP则可以正常使用。

如果对Linux运维已有一定了解，可以选择自行安装所有依赖包，最终安装Asterisk。这种操作有点复杂，我还没有完整试过。

出于简单易用，而又不失稳定性，我推荐先尝试使用官方集成的Linux系统进行初步的学习与测试。在VMware Workstation中新建虚拟机并安装镜像（[百度网盘](https://pan.baidu.com/s/1CVs0X7zSa3q0Tgti5BVdLA) 提取码：j7cx），就可以快速获得一个能直接使用的Asterisk。简单掌握Linux命令行即可完成整个服务器的配置工作。对于Linux新手，另外推荐两个实用工具，[putty](https://www.chiark.greenend.org.uk/~sgtatham/putty/)与[pscp](https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html)，便于进行宿主机与虚拟机之间的文本复制与命令传输。

以下内容将基于已经建立好所需环境，完整安装了Asterisk这一前提。

---

## 拨号配置

默认情况下，Asterisk的配置文件都放在``/etc/asterisk``目录下，使用Vim在终端中打开就可以编辑。

接下来介绍在本次配置当中需要用到的几个配置文件，更多的配置规则及解释可以参考[这份中文资料](https://wy19990110.github.io/files/1.pdf)。

### IAX通道配置文件 [iax.conf](/files/AsteriskServer/iax.conf)

这个文件定义了IAX通道的基本设置。

### SIP通道配置文件 [sip.conf](/files/AsteriskServer/sip.conf)

这个文件定义了SIP通道的基本设置。

从上面这份介绍Asterisk的小册子中，我们可以粗略地领会到：Asterisk如同一个路由器般工作，将不同来源的音频输入进行转发。如果两个音频信号来自同一个协议，就可以直接将它们接到一起，由这个相同的协议负责网络通信，这种情形就像交换机一样，直接在“链路层”就完成了交换。

而如果两个音频流来自于不同的协议，Asterisk就得负责起不同协议间的“翻译”。比如一位用户使用SIP，而另一位使用IAX2，那么Asterisk就要不停地将SIP协议带来的音频流解码，装入IAX格式的包，发送出去，另一个方向也是如此。这时候的Asterisk就像一个网桥。

这样来看，不同的通道就像是一个带桥接功能的路由器上不同类型的接入，比如以太网、蜂窝网络、红外、串口之间的互相通信。通道的配置则像是串口的比特率之类的项目。

以上两个配置文件直接下载后写到对应的配置文件中就行。在为FGCOM提供服务的过程中，这两个配置文件都不需要改动。

### 拨号规则  [extensions.conf](/files/AsteriskServer/extensions.conf)

最基本的拨号规则写在extensions.conf文件中。除此之外，还可以用脚本等方式编写、导入拨号规则。

由上面两个文件可以看出，Asterisk的配置文件遵循惯例，由若干个**段**组成。每个段由方括号包裹的段名开始，直至下一个段的段名之前结束。

extensions.conf文件头部是两个全局设置段，第一个段是关于拨号规则的设置，如写保护。第二个段定义了一些全局变量，使得它们可以在后续的规则段中被使用。

    [general]
    writeprotect=yes
    ;
    [globals]
    ATIS_RECORDINGS=/var/spool/asterisk/recordings/atis
    ATIS_PASSWD=/home/fgregister/atis_passwd.txt

``general``与``globals``可以视为被保留的关键字。使用其余段名的段会被识别为拨号规则。在任何段中的拨号规则都会起作用，段名与分段主要为了便于编辑。

Asterisk使用了一种比较简单的拨号规则语法，不过在复合与嵌套下可以实现复杂的功能。
一条基本的语句由一个``exten =>``符号，以及这个箭头后面的内容构成。

本文中提供的extensions.conf文件中写入了ZUUU机场的通信频率。
使用[FGCOM官方提供的Perl脚本](http://wiki.flightgear.org/Howto:Set_up_a_FGCom_server)（最下方）可以将导航数据文件中的通信频率转写为拨号规则。

将这三个文件放进前述的``/etc/asterisk``目录下。如果使用的是Linux，在终端执行``asterisk``命令即可启动Asterisk服务。此时已经可以为FGCOM提供语音接入服务了。

使用``asterisk -r``命令可以远程连入控制台，Asterisk的CLI可以实现更多调试功能。
